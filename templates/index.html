<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader</title>
    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/static/logo.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        html { background-color: #121212; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 40px; min-height: 100vh; display: flex; flex-direction: column; color: #e0e0e0; }
        .content-wrapper { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; padding: 20px; }
        .main-card { background-color: #1e1e1e; color: #e0e0e0; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 100%; max-width: 600px; margin: 0; padding: 30px; border-radius: 20px; }
        .app-title { font-weight: 700; color: #ffffff; margin-bottom: 30px; }
        .quality-buttons-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; }
        .quality-btn { flex: 1 1 140px; padding: 12px; border-radius: 12px; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; }
        .quality-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .thumbnail-box { margin: 20px 0; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .thumbnail-box img { width: 100%; display: block; transition: transform 0.3s ease; }
        .thumbnail-box:hover img { transform: scale(1.05); }
        #progress-section { display: none; margin-top: 25px; background: #2d2d2d; color: #ffffff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .progress { height: 20px; border-radius: 10px; background-color: #444; }
        #download-section { display: none; margin-top: 25px; text-align: center; }
        .btn-download-file { width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 12px; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar { position: absolute; top: 25px; right: 25px; z-index: 100; display: flex; align-items: center; gap: 15px; background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding: 8px 20px; border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .top-bar .btn { border-radius: 20px; font-weight: 600; }
        .brand-logo { position: absolute; top: 20px; left: 20px; z-index: 100; font-weight: 800; font-size: 1.5rem; text-decoration: none; color: #e0e0e0; font-family: 'Montserrat', sans-serif; display: flex; align-items: center; gap: 10px; -webkit-tap-highlight-color: transparent; }
        .brand-logo img { height: 40px; width: auto; }
        
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 99999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease-out, visibility 0.5s; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
        #splash-screen img { max-width: 300px; width: 60%; height: auto; animation: logo-bounce 1.2s ease-out forwards; user-select: none; -webkit-user-drag: none; pointer-events: none; }
        @keyframes logo-bounce { 0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1.1); } 70% { transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        
        /* –°–Ω–µ–≥ */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; transition: transform 0.1s ease-out; }
        .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; user-select: none; pointer-events: none; animation: fall linear infinite; box-shadow: 0 0 5px rgba(255,255,255,0.8); }
        @keyframes fall { to { transform: translateY(120vh); } }
        .snow-pile { position: fixed; bottom: 0; left: 0; width: 100%; height: 15px; background: rgba(255, 255, 255, 0.6); filter: blur(8px); z-index: 9998; pointer-events: none; }
        
        /* FreeKassa */
        .freekassa-corner { position: fixed; bottom: 15px; left: 15px; z-index: 9000; opacity: 0.6; transition: all 0.3s ease; transform: scale(0.85); transform-origin: bottom left; }
        .freekassa-corner:hover { opacity: 1; transform: scale(1); }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ */
        .feedback-corner { position: fixed; bottom: 30px; right: 30px; z-index: 9000; }
        .feedback-btn {
            width: 60px; height: 60px;
            background-color: #ffc107; color: #000;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 28px; text-decoration: none;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
            transition: transform 0.3s ease;
            animation: pulse-yellow 2s infinite;
        }
        .feedback-btn:hover { transform: scale(1.1); color: #000; }
        @keyframes pulse-yellow {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }
        
        /* Toggles */
        .form-switch .form-check-input { height: 1.5em; width: 2.5em; border-radius: 2em; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e"); transition: background-position .15s ease-in-out, background-color .15s ease-in-out; cursor: pointer; }
        .form-switch .form-check-input:checked { background-color: #34C759; border-color: #34C759; }
        .form-switch .form-check-input:focus { box-shadow: none; }
        
        @media (max-width: 768px) {
            .brand-logo, .top-bar { position: static; display: flex; justify-content: center; width: 100%; margin-bottom: 15px; background: transparent; border: none; box-shadow: none; padding: 0; }
            .content-wrapper { padding-top: 10px; }
            .brand-logo { order: 1; }
            .top-bar { order: 2; }
            .main-card { order: 3; }
        }
        
        /* --- –°–¢–ò–õ–ò–ó–ê–¶–ò–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù (Glassmorphism) --- */
        .modal-content {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            color: #e0e0e0;
        }
        .modal-header, .modal-footer { border-color: rgba(255, 255, 255, 0.1); }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .list-group-item { background: transparent; border-color: rgba(255, 255, 255, 0.1); color: #e0e0e0; }
        .list-group-item:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }
        .list-group-item-action:active { background: rgba(255, 255, 255, 0.1); color: #fff; }
        
        /* SweetAlert2 Dark Theme Overrides */
        div:where(.swal2-container) div:where(.swal2-popup) { background: #1e1e1e !important; color: #e0e0e0 !important; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm { background-color: #0d6efd !important; border-radius: 10px; }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-cancel { background-color: #343a40 !important; border-radius: 10px; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–Ω–ª–∞–π–Ω (–∑–µ–ª–µ–Ω–∞—è –ø—É–ª—å—Å–∞—Ü–∏—è) */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        .avatar-online {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body>

<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
<div id="splash-screen">
    <!-- –°—Ç–∞—Ç–∏—á–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø —Å CSS –∞–Ω–∏–º–∞—Ü–∏–µ–π -->
    <img src="/static/startup_logo.png" alt="Video Downloader" draggable="false" oncontextmenu="return false;">
</div>

<script>
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É –ø—Ä–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "–±–µ–ª–æ–π –≤—Å–ø—ã—à–∫–∏"
    (function(){
        try {
            var s = document.getElementById('splash-screen');
            var isReload = false;
            try {
                if (window.performance && window.performance.navigation && window.performance.navigation.type === 1) isReload = true;
                if (window.performance && window.performance.getEntriesByType && window.performance.getEntriesByType("navigation")[0] && window.performance.getEntriesByType("navigation")[0].type === 'reload') isReload = true;
            } catch(e){}
            
            if (s && !isReload && document.referrer && document.referrer.indexOf(window.location.origin) === 0) { s.style.display = 'none'; }
        } catch(e){}
    })();
</script>

<div class="content-wrapper container mb-5">
    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ —Å–ª–µ–≤–∞ -->
    <a href="/" class="brand-logo">
        <img src="/static/logo.png" alt="Logo" onerror="this.style.display='none'">
        Video Downloader
    </a>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="top-bar">
        <a href="/premium" id="topBarPremiumBtn" class="btn btn-sm btn-warning text-dark fw-bold" style="background: linear-gradient(45deg, #FFD700, #FFC107); border: none; box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);"><i class="bi bi-gem"></i> Premium</a>
        <button class="btn btn-sm btn-dark rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 0;" onclick="new bootstrap.Modal(document.getElementById('settingsModal')).show()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i class="bi bi-gear-fill"></i></button>
        <div id="authSection" class="d-flex gap-2 align-items: center">
            <!-- JS –≤—Å—Ç–∞–≤–∏—Ç –∫–Ω–æ–ø–∫–∏ -->
        </div>
    </div>

    <div class="main-card">

        <h2 class="text-center app-title" id="mainTitle">
            –°–∫–∞—á–∞—Ç—å –í–∏–¥–µ–æ
        </h2>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ª–∏–º–∏—Ç–∞ –¥–ª—è Free –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        {% if not is_premium and session.get('user_id') %}
        <div class="mb-3 text-center">
            <span class="badge rounded-pill {{ 'bg-danger' if limit_reached else 'bg-secondary' }} bg-opacity-25 text-light border border-secondary border-opacity-25 px-3 py-2">
                <i class="bi bi-cloud-download"></i> –õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: <b>{{ downloads_today }}/5</b>
            </span>
            {% if limit_reached %}
            <div class="mt-3 p-3 rounded-3 border border-danger border-opacity-50 bg-danger bg-opacity-10">
                <div class="text-danger fw-bold mb-2"><i class="bi bi-exclamation-circle-fill"></i> –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω</div>
                <div class="small text-white-50 mb-2">–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ 5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∫–∞—á–∏–≤–∞–Ω–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</div>
                <a href="/premium" class="btn btn-sm btn-warning fw-bold text-dark shadow-sm">–°–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è</a>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="input-group mb-3">
            <input type="text" id="urlInput" class="form-control form-control-lg" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É YouTube..." aria-label="URL" oninput="validateUrl()" onpaste="setTimeout(() => { if(validateUrl()) getInfo(); }, 100)" {% if limit_reached %}disabled{% endif %}>
            <button id="searchBtn" class="btn btn-primary btn-lg" type="button" onclick="getInfo()" disabled {% if limit_reached %}disabled{% endif %}>–ò—Å–∫–∞—Ç—å</button>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (—Å–∫—Ä—ã—Ç–∞—è) -->
        <div class="mb-3 text-center">
            <a class="text-decoration-none small text-muted" data-bs-toggle="collapse" href="#howToUse" role="button" aria-expanded="false" id="howToLink">
                <i class="bi bi-question-circle"></i> –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?
            </a>
            <div class="collapse mt-2" id="howToUse">
                <div class="alert alert-secondary small text-start m-0" id="howToContent">
                    <ol class="mb-0 ps-3">
                        <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ.</li>
                        <li>–í—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ –ø–æ–ª–µ (–ø–æ–∏—Å–∫ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å–∫–∞—á–∞–π—Ç–µ.</li>
                    </ol>
                    <div class="mt-2 text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ 18+ –∑–∞–ø—Ä–µ—â–µ–Ω–æ!</div>
                    <div class="mt-2"><i class="bi bi-info-circle-fill text-primary"></i> <b>–í–∞–∂–Ω–æ:</b> –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.</div>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∏–¥–µ–æ -->
        <div id="videoInfo" style="display:none;">
            <div class="thumbnail-box">
                <img id="thumb" src="" alt="Thumbnail">
            </div>
            <h5 id="videoTitle" class="text-center mb-2"></h5>
            <p class="text-center text-muted small"><span id="lblDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</span> <span id="duration"></span></p>

            <div class="text-center mb-3 text-secondary" id="lblQuality">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ:</div>
            
            <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫–Ω–æ–ø–∫–∏ -->
            <div class="quality-buttons-container" id="buttonsContainer">
                <!-- –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ -->
            <div id="playlistContainer" class="mt-4" style="display: none;"></div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä) -->
        <div id="progress-section">
            <div class="d-flex justify-content-between mb-1">
                <span id="statusText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                <span id="percentText">0%</span>
            </div>
            <div class="progress">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ -->
        <div id="download-section">
            <a id="downloadBtn" href="#" class="btn btn-success btn-download-file mb-3"><i class="bi bi-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª</a>
            <!-- –ö–Ω–æ–ø–∫–∞ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
            <button id="shareBtn" class="btn btn-primary btn-download-file mb-3" style="display: none;" onclick="shareFile()"> <i class="bi bi-share"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="btn btn-outline-secondary w-100" onclick="location.reload()" id="btnReload">–°–∫–∞—á–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ</button>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–≤–∞–ª -->
<div class="container text-center">
    <div class="footer-links mb-3">
        <a href="/about" id="footerAbout" class="text-muted mx-2 text-decoration-none">–û –Ω–∞—Å</a>
        <a href="/privacy" id="footerPrivacy" class="text-muted mx-2 text-decoration-none">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</a>
        <a href="/terms" id="footerTerms" class="text-muted mx-2 text-decoration-none">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
    </div>
    <div class="text-muted mt-2 small" id="footerCopyright">&copy; 2025 Video Downloader</div>
</div>

<!-- –ë–∞–Ω–Ω–µ—Ä Cookies -->
<div id="cookie-banner" style="display:none; position: fixed; bottom: 0; left: 0; right: 0; background-color: #212529; color: white; padding: 15px; text-align: center; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.2);">
    <div class="container d-flex justify-content-center align-items-center flex-wrap gap-3">
        <span class="small text-start" style="max-width: 600px;" id="cookieText"></span>
        <button class="btn btn-sm btn-success" onclick="acceptCookies()" id="cookieAccept">–ü—Ä–∏–Ω—è—Ç—å</button>
        <button class="btn btn-sm btn-outline-light" onclick="rejectCookies()" id="cookieReject">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤—Å–µ</button>
    </div>
</div>

<!-- –°—É–≥—Ä–æ–± –∏ —Å–Ω–µ–≥ -->
<div class="snow-pile"></div>
<div id="snow-container"></div>

<!-- FreeKassa -->
<div class="freekassa-corner">
    <a href="https://freekassa.net" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.freekassa.net/banners/big-dark-2.png" title="–ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π" style="height: 40px; width: auto; border-radius: 8px;">
    </a>
</div>

<!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ -->
<div class="feedback-corner">
    <a href="/feedback" class="feedback-btn" title="–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"><i class="bi bi-chat-dots-fill"></i></a>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalTitle">üìÇ –ú–æ–∏ —Å–∫–∞—á–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ</h5>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-outline-danger me-2" onclick="clearHistory()" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"><i class="bi bi-trash"></i></button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body"><div id="historyList" class="list-group"><div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="notificationHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="notifModalTitle">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><div id="notificationList" class="list-group list-group-flush"></div></div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
  <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex"><div class="toast-body" id="toastBody"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>
  </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="background: #1e1e1e; color: #e0e0e0;">
            <div class="modal-header border-secondary"><h5 class="modal-title" id="settingsTitle"><i class="bi bi-gear-fill"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label text-muted small mb-1">–Ø–∑—ã–∫ / Language</label><select class="form-select form-select-sm bg-dark text-white border-secondary" id="settingLang" onchange="saveSettings()"><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="en">English</option><option value="kg">–ö—ã—Ä–≥—ã–∑—á–∞</option></select></div>
                <div class="form-check form-switch mb-3 d-flex justify-content-between align-items-center ps-0"><label class="form-check-label" for="settingSnow" id="lblSnow">‚ùÑÔ∏è –°–Ω–µ–≥–æ–ø–∞–¥</label><input class="form-check-input ms-auto" type="checkbox" id="settingSnow" onchange="saveSettings()"></div>
                <div class="form-check form-switch mb-3 d-flex justify-content-between align-items-center ps-0"><label class="form-check-label" for="settingSound" id="lblSound">üîä –ó–≤—É–∫–∏</label><input class="form-check-input ms-auto" type="checkbox" id="settingSound" onchange="saveSettings()"></div>
                <div class="form-check form-switch mb-3 d-flex justify-content-between align-items-center ps-0"><label class="form-check-label" for="settingToasts" id="lblToasts">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label><input class="form-check-input ms-auto" type="checkbox" id="settingToasts" onchange="saveSettings()"></div>
                <div class="form-check form-switch mb-3 d-flex justify-content-between align-items-center ps-0"><label class="form-check-label" for="settingRelax" id="lblRelax">üåä –†–µ–ª–∞–∫—Å (–î–æ–∂–¥—å)</label><input class="form-check-input ms-auto" type="checkbox" id="settingRelax" onchange="saveSettings()"></div>
                <div class="mt-4 pt-3 border-top border-secondary"><button class="btn btn-sm btn-outline-danger w-100" onclick="clearCache()" id="btnClearCache"><i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–≤–æ–¥—ã
window.appSettings = { snow: true, sound: true, toasts: true, lang: 'ru', relax: false };
window.translations = {
    ru: {
        title: '–°–∫–∞—á–∞—Ç—å –í–∏–¥–µ–æ', searchPlaceholder: '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É YouTube...', searchBtn: '–ù–∞–π—Ç–∏', howTo: '<i class="bi bi-question-circle"></i> –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?',
        settingsTitle: '<i class="bi bi-gear-fill"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏', snow: '‚ùÑÔ∏è –°–Ω–µ–≥–æ–ø–∞–¥', sound: 'üîä –ó–≤—É–∫–∏', toasts: 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', relax: 'üåä –†–µ–ª–∞–∫—Å (–î–æ–∂–¥—å)', clearCache: '<i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à',
        footerAbout: '–û –Ω–∞—Å', footerPrivacy: '–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å', footerTerms: '–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', footerFeedback: '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å', footerCopyright: '&copy; 2025 Video Downloader',
        cookieText: 'üç™ <b>–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª—ã cookie.</b><br>–û–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–º—ã, –≤—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç) –∏ —É–ª—É—á—à–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –æ–ø—ã—Ç–∞.', cookieAccept: '–ü—Ä–∏–Ω—è—Ç—å', cookieReject: '–û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤—Å–µ',
        howToContent: '<ol class="mb-0 ps-3"><li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ.</li><li>–í—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ –ø–æ–ª–µ (–ø–æ–∏—Å–∫ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).</li><li>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å–∫–∞—á–∞–π—Ç–µ.</li></ol><div class="mt-2 text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ 18+ –∑–∞–ø—Ä–µ—â–µ–Ω–æ!</div><div class="mt-2"><i class="bi bi-info-circle-fill text-primary"></i> <b>–í–∞–∂–Ω–æ:</b> –ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –≤–æ—à–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç.</div>',
        lblDuration: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', lblQuality: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ:', btnReload: '–°–∫–∞—á–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ',
        historyModalTitle: 'üìÇ –ú–æ–∏ —Å–∫–∞—á–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ', notifModalTitle: 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
        authLogin: '–í—Ö–æ–¥', authRegister: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
        historyEmpty: '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞', noNotifications: '–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', loading: '–ó–∞–≥—Ä—É–∑–∫–∞...', errorLoad: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏',
        clearHistoryConfirm: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–π?', deleteNotifConfirm: '–£–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?',
        btnDownload: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª', btnShare: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è', btnGetPremium: '–ö—É–ø–∏—Ç—å Premium', btnPremiumActive: 'Premium –ê–∫—Ç–∏–≤–µ–Ω',
        qualityBest: '–õ—É—á—à–µ–µ (MP4)', quality1080: '1080p (MP4)', quality720: '720p (MP4)', qualityAudio: '–ê—É–¥–∏–æ (MP3)',
        statusDownloading: '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...', statusProcessing: '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–∫–ª–µ–∏–≤–∞–Ω–∏–µ...', statusFinished: '–ì–æ—Ç–æ–≤–æ!', statusError: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏: ',
        searchingFree: '–ü–æ–∏—Å–∫ (Free –æ—á–µ—Ä–µ–¥—å)...', searchingPremium: '–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫...'
    },
    en: {
        title: 'Download Video', searchPlaceholder: 'Paste YouTube link...', searchBtn: 'Search', howTo: '<i class="bi bi-question-circle"></i> How to use?',
        settingsTitle: '<i class="bi bi-gear-fill"></i> Settings', snow: '‚ùÑÔ∏è Snowfall', sound: 'üîä Sounds', toasts: 'üîî Notifications', relax: 'üåä Relax (Rain)', clearCache: '<i class="bi bi-trash"></i> Clear Cache',
        footerAbout: 'About us', footerPrivacy: 'Privacy', footerTerms: 'Terms of Use', footerFeedback: 'Feedback', footerCopyright: '&copy; 2025 Video Downloader',
        cookieText: 'üç™ <b>We use cookies.</b><br>They are necessary for the site to work (saving theme, login) and improving your experience.', cookieAccept: 'Accept', cookieReject: 'Reject all',
        howToContent: '<ol class="mb-0 ps-3"><li>Copy the video link.</li><li>Paste it into the field (search starts automatically).</li><li>Select quality and download.</li></ol><div class="mt-2 text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Downloading 18+ video is prohibited!</div><div class="mt-2"><i class="bi bi-info-circle-fill text-primary"></i> <b>Important:</b> Download history is saved only if you are logged in.</div>',
        lblDuration: 'Duration:', lblQuality: 'Select quality:', btnReload: 'Download another video',
        historyModalTitle: 'üìÇ My downloads', notifModalTitle: 'üîî Notifications',
        authLogin: 'Login', authRegister: 'Register',
        historyEmpty: 'History is empty', noNotifications: 'No notifications', loading: 'Loading...', errorLoad: 'Error loading',
        clearHistoryConfirm: 'Are you sure you want to clear download history?', deleteNotifConfirm: 'Delete notification from history?',
        btnDownload: 'Save file', btnShare: 'Share', btnGetPremium: 'Get Premium', btnPremiumActive: 'Premium Active',
        qualityBest: 'Best (MP4)', quality1080: '1080p (MP4)', quality720: '720p (MP4)', qualityAudio: 'Audio (MP3)',
        statusDownloading: 'Downloading...', statusProcessing: 'Processing and merging...', statusFinished: 'Done!', statusError: 'Download error: ',
        searchingFree: 'Searching (Free queue)...', searchingPremium: 'Instant search...'
    },
    kg: {
        title: '–í–∏–¥–µ–æ –ñ“Ø–∫—Ç”©”©', searchPlaceholder: 'YouTube —à–∏–ª—Ç–µ–º–µ—Å–∏–Ω –∫–æ—é“£—É–∑...', searchBtn: '–ò–∑–¥”©”©', howTo: '<i class="bi bi-question-circle"></i> –ö–∞–Ω—Ç–∏–ø –∫–æ–ª–¥–æ–Ω—É—É –∫–µ—Ä–µ–∫?',
        settingsTitle: '<i class="bi bi-gear-fill"></i> –¢”©–Ω–¥”©”©–ª”©—Ä', snow: '‚ùÑÔ∏è –ö–∞—Ä –∂–∞–∞—à—ã', sound: 'üîä “Æ–Ω–¥”©—Ä', toasts: 'üîî –ë–∏–ª–¥–∏—Ä“Ø“Ø–ª”©—Ä', relax: 'üåä –†–µ–ª–∞–∫—Å (–ñ–∞–º–≥—ã—Ä)', clearCache: '<i class="bi bi-trash"></i> –ö—ç—à—Ç–∏ —Ç–∞–∑–∞–ª–æ–æ',
        footerAbout: '–ë–∏–∑ –∂”©–Ω“Ø–Ω–¥”©', footerPrivacy: '–ö—É–ø—É—è–ª—É—É–ª—É–∫', footerTerms: '–ö–æ–ª–¥–æ–Ω—É—É —à–∞—Ä—Ç—Ç–∞—Ä—ã', footerFeedback: '–ë–∞–π–ª–∞–Ω—ã—à', footerCopyright: '&copy; 2025 Video Downloader',
        cookieText: 'üç™ <b>–ë–∏–∑ cookie —Ñ–∞–π–ª–¥–∞—Ä—ã–Ω –∫–æ–ª–¥–æ–Ω–æ–±—É–∑.</b><br>–ê–ª–∞—Ä —Å–∞–π—Ç—Ç—ã–Ω –∏—à—Ç–µ—à–∏ “Ø—á“Ø–Ω –∫–µ—Ä–µ–∫ (—Ç–µ–º–∞–Ω—ã —Å–∞–∫—Ç–æ–æ, –∞–∫–∫–∞—É–Ω—Ç–∫–∞ –∫–∏—Ä“Ø“Ø).', cookieAccept: '–ö–∞–±—ã–ª –∞–ª—É—É', cookieReject: '–ë–∞–∞—Ä—ã–Ω —á–µ—Ç–∫–µ –∫–∞–≥—É—É',
        howToContent: '<ol class="mb-0 ps-3"><li>–í–∏–¥–µ–æ–Ω—É–Ω —à–∏–ª—Ç–µ–º–µ—Å–∏–Ω –∫”©—á“Ø—Ä“Ø“£“Ø–∑.</li><li>–ê–Ω—ã —Ç–∞–ª–∞–∞–≥–∞ –∫–æ—é“£—É–∑ (–∏–∑–¥”©”© –∞–≤—Ç–æ–º–∞—Ç—Ç—ã–∫ —Ç“Ø—Ä–¥”© –±–∞—à—Ç–∞–ª–∞—Ç).</li><li>–°–∞–ø–∞—Ç—Ç—ã —Ç–∞–Ω–¥–∞–ø, –∂“Ø–∫—Ç”©–ø –∞–ª—ã“£—ã–∑.</li></ol><div class="mt-2 text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> 18+ –≤–∏–¥–µ–æ–ª–æ—Ä–¥—É –∂“Ø–∫—Ç”©”©–≥”© —Ç—ã—é—É —Å–∞–ª—ã–Ω–∞—Ç!</div>',
        lblDuration: '–£–∑–∞–∫—Ç—ã–≥—ã:', lblQuality: '–°–∞–ø–∞—Ç—Ç—ã —Ç–∞–Ω–¥–∞“£—ã–∑:', btnReload: '–ë–∞—à–∫–∞ –≤–∏–¥–µ–æ –∂“Ø–∫—Ç”©”©',
        historyModalTitle: 'üìÇ –ú–µ–Ω–∏–Ω –∂“Ø–∫—Ç”©–¥“Ø“Ø–ª”©—Ä“Ø–º', notifModalTitle: 'üîî –ë–∏–ª–¥–∏—Ä“Ø“Ø–ª”©—Ä',
        authLogin: '–ö–∏—Ä“Ø“Ø', authRegister: '–ö–∞—Ç—Ç–æ–æ',
        historyEmpty: '–¢–∞—Ä—ã—Ö –±–æ—à', noNotifications: '–ë–∏–ª–¥–∏—Ä“Ø“Ø–ª”©—Ä –∂–æ–∫', loading: '–ñ“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...', errorLoad: '–ñ“Ø–∫—Ç”©”© –∫–∞—Ç–∞—Å—ã',
        clearHistoryConfirm: '–°–∏–∑ –∂“Ø–∫—Ç”©”© —Ç–∞—Ä—ã—Ö—ã–Ω —Ç–∞–∑–∞–ª–æ–æ–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã?', deleteNotifConfirm: '–ë–∏–ª–¥–∏—Ä“Ø“Ø–Ω“Ø —Ç–∞—Ä—ã—Ö—Ç–∞–Ω ”©—á“Ø—Ä“Ø“Ø?',
        btnDownload: '–§–∞–π–ª–¥—ã —Å–∞–∫—Ç–æ–æ', btnShare: '–ë”©–ª“Ø—à“Ø“Ø', btnGetPremium: 'Premium –∞–ª—É—É', btnPremiumActive: 'Premium –ê–∫—Ç–∏–≤–¥“Ø“Ø',
        qualityBest: '–ú—ã–∫—Ç—ã (MP4)', quality1080: '1080p (MP4)', quality720: '720p (MP4)', qualityAudio: '–ê—É–¥–∏–æ (MP3)',
        statusDownloading: '–ñ“Ø–∫—Ç”©–ª“Ø“Ø–¥”©...', statusProcessing: '–ò—à—Ç–µ–ø —á—ã–≥—É—É –∂–∞–Ω–∞ –±–∏—Ä–∏–∫—Ç–∏—Ä“Ø“Ø...', statusFinished: '–î–∞—è—Ä!', statusError: '–ñ“Ø–∫—Ç”©”© –∫–∞—Ç–∞—Å—ã: ',
        searchingFree: '–ò–∑–¥”©”© (Free –∫–µ–∑–µ–∫)...', searchingPremium: '–¢–µ–∑ –∏–∑–¥”©”©...'
    }
};

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let lastAuthData = { isAuth: false, username: '', avatarUrl: '', isPremium: false, isAdmin: false };
    let authCheckPromise = null;
    let currentTaskId = null;
    let progressInterval = null;
    let relaxCtx = null, relaxGain = null, relaxFilter = null;

    // --- –£–¢–ò–õ–ò–¢–´ ---
    const Utils = {
        getCsrfToken: () => document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
        createElement: (tag, classes, text) => {
            const el = document.createElement(tag);
            if (classes) el.className = classes;
            if (text) el.textContent = text;
            return el;
        }
    };

    // --- –ó–í–£–ö –†–ï–õ–ê–ö–° ---
    function toggleRelaxSound(enable) {
        if (enable) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                if (!relaxCtx) relaxCtx = new AudioContext();
                if (relaxCtx.state === 'suspended') relaxCtx.resume().catch(() => {});
                if (!relaxGain) {
                    const bufferSize = 2 * relaxCtx.sampleRate;
                    const buffer = relaxCtx.createBuffer(1, bufferSize, relaxCtx.sampleRate);
                    const output = buffer.getChannelData(0);
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5;
                    }
                    const noise = relaxCtx.createBufferSource();
                    noise.buffer = buffer;
                    noise.loop = true;
                    relaxGain = relaxCtx.createGain();
                    relaxGain.gain.value = 0;
                    relaxFilter = relaxCtx.createBiquadFilter();
                    relaxFilter.type = 'lowpass';
                    relaxFilter.frequency.value = 400;
                    noise.connect(relaxFilter);
                    relaxFilter.connect(relaxGain);
                    relaxGain.connect(relaxCtx.destination);
                    noise.start(0);
                }
                relaxGain.gain.setTargetAtTime(0.15, relaxCtx.currentTime, 0.5);
            } catch (e) { console.error(e); }
        } else {
            if (relaxGain && relaxCtx) {
                try {
                    relaxGain.gain.setTargetAtTime(0, relaxCtx.currentTime, 0.5);
                    setTimeout(() => { if (relaxCtx && relaxCtx.state === 'running') relaxCtx.suspend(); }, 500);
                } catch (e) {}
            }
        }
    }

    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    window.loadSettings = function() {
        const saved = localStorage.getItem('appSettings');
        if (saved) {
            window.appSettings = { ...window.appSettings, ...JSON.parse(saved) };
        } else {
            const browserLang = navigator.language || navigator.userLanguage;
            if (browserLang.startsWith('ru')) window.appSettings.lang = 'ru';
            else if (browserLang.startsWith('ky') || browserLang.startsWith('kg')) window.appSettings.lang = 'kg';
            else window.appSettings.lang = 'en';
        }
        
        const setCheck = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        
        setCheck('settingSnow', window.appSettings.snow);
        setCheck('settingSound', window.appSettings.sound);
        setCheck('settingToasts', window.appSettings.toasts);
        setCheck('settingRelax', window.appSettings.relax);
        setVal('settingLang', window.appSettings.lang || 'ru');
        
        applySettings();
    }

    window.saveSettings = function() {
        const getCheck = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : 'ru'; };

        window.appSettings.snow = getCheck('settingSnow');
        window.appSettings.sound = getCheck('settingSound');
        window.appSettings.toasts = getCheck('settingToasts');
        window.appSettings.relax = getCheck('settingRelax');
        window.appSettings.lang = getVal('settingLang');
        
        localStorage.setItem('appSettings', JSON.stringify(window.appSettings));
        applySettings();
    }

    function applySettings() {
        const pile = document.querySelector('.snow-pile');
        const container = document.getElementById('snow-container');
        if (window.appSettings.snow) {
            if (pile) pile.style.display = 'block';
        } else {
            if (pile) pile.style.display = 'none';
            if (container) container.innerHTML = '';
        }

        const t = window.translations[window.appSettings.lang];
        if (t) {
            const elementsToTranslate = {
                'mainTitle': 'title', 'urlInput': 'searchPlaceholder', 'searchBtn': 'searchBtn', 'howToLink': 'howTo',
                'settingsTitle': 'settingsTitle', 'lblSnow': 'snow', 'lblSound': 'sound', 'lblToasts': 'toasts', 'lblRelax': 'relax', 'btnClearCache': 'clearCache',
                'footerAbout': 'footerAbout', 'footerPrivacy': 'footerPrivacy', 'footerTerms': 'footerTerms', 'footerFeedback': 'footerFeedback', 'footerCopyright': 'footerCopyright',
                'cookieText': 'cookieText', 'cookieAccept': 'cookieAccept', 'cookieReject': 'cookieReject',
                'howToContent': 'howToContent', 'lblDuration': 'lblDuration', 'lblQuality': 'lblQuality', 'btnReload': 'btnReload',
                'historyModalTitle': 'historyModalTitle', 'notifModalTitle': 'notifModalTitle'
            };
            for (const id in elementsToTranslate) {
                const el = document.getElementById(id);
                if (el) {
                    const key = elementsToTranslate[id];
                    if (id === 'urlInput') el.placeholder = t[key];
                    else el.innerHTML = t[key];
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
            if(document.getElementById('downloadBtn')) document.getElementById('downloadBtn').innerHTML = `<i class="bi bi-download"></i> ${t.btnDownload}`;
            if(document.getElementById('shareBtn')) document.getElementById('shareBtn').innerHTML = `<i class="bi bi-share"></i> ${t.btnShare}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É Premium –≤ —à–∞–ø–∫–µ
            const premBtn = document.getElementById('topBarPremiumBtn');
            if (premBtn) {
                premBtn.innerHTML = `<i class="bi bi-gem"></i> ${lastAuthData.isPremium ? t.btnPremiumActive : t.btnGetPremium}`;
            }
        }
        toggleRelaxSound(window.appSettings.relax);
        updateAuthUI(lastAuthData.isAuth, lastAuthData.username, lastAuthData.avatarUrl, lastAuthData.isPremium);
    }

    window.clearCache = function() {
        const t = window.translations[window.appSettings.lang] || window.translations['ru'];
        const confirmMsg = window.appSettings.lang === 'ru' ? '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å?' : (window.appSettings.lang === 'kg' ? '–ë–∞—Ä–¥—ã–∫ –∂”©–Ω–¥”©”©–ª”©—Ä–¥“Ø —Ç–∞–∑–∞–ª–∞–ø, –∫–∞–π—Ä–∞ –∂“Ø–∫—Ç”©–π–±“Ø–∑–±“Ø?' : 'Reset all settings and reload?');
        
        Swal.fire({
            title: t.settingsTitle,
            text: confirmMsg,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '–î–∞',
            cancelButtonText: '–ù–µ—Ç'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.clear();
                location.reload(true);
            }
        });
    }

    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–ø–µ—Ä–µ–¥–µ–ª–∞–Ω–æ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ Promise –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤) ---
    async function checkAuth() {
        if (authCheckPromise) {
            return authCheckPromise; // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Promise
        }

        authCheckPromise = (async () => {
            try {
                const res = await fetch('/check_auth');
                const data = await res.json();
                lastAuthData = { isAuth: data.authenticated, username: data.username, avatarUrl: data.avatar_url, isPremium: data.is_premium, isAdmin: data.is_admin };
                updateAuthUI(data.authenticated, data.username, data.avatar_url, data.is_premium, data.is_admin);
                return data;
            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", e);
                lastAuthData = { isAuth: false, username: '', avatarUrl: '', isPremium: false, isAdmin: false }; // –°–±—Ä–æ—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ
                return { authenticated: false };
            } finally {
                authCheckPromise = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º Promise –ø–æ—Å–ª–µ –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
            }
        })();
        return authCheckPromise;
    }
    window.checkAuth = checkAuth;

    function updateAuthUI(isAuth, username, avatarUrl, isPremium, isAdmin) {
        const t = window.translations[window.appSettings.lang] || window.translations['ru'];
        const container = document.getElementById('authSection');
        if (!container) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ Premium –≤ —à–∞–ø–∫–µ
        const premBtn = document.getElementById('topBarPremiumBtn');
        if (premBtn) {
            premBtn.innerHTML = `<i class="bi bi-gem"></i> ${isPremium ? t.btnPremiumActive : t.btnGetPremium}`;
        }

        if (isAuth) {
            const imgUrl = avatarUrl || 'https://via.placeholder.com/40';
            const avatarHtml = `<a href="/profile"><img src="${imgUrl}" alt="Avatar" class="rounded-circle border border-2 border-light avatar-online" style="width: 40px; height: 40px; object-fit: cover;"></a>`;
            const adminBadge = isAdmin ? '<div class="badge bg-info text-dark mt-1 shadow-sm" style="font-size: 0.6rem; padding: 2px 6px; line-height: 1;"><i class="bi bi-shield-lock"></i> ADMIN</div>' : '';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "PREMIUM" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–ª–∞—Ç–Ω—ã–π –ø—Ä–µ–º–∏—É–º, –∞ –Ω–µ –∞–¥–º–∏–Ω
            const premiumBadge = (isPremium && !isAdmin) ? '<div class="badge bg-warning text-dark mt-1 shadow-sm" style="font-size: 0.6rem; padding: 2px 6px; line-height: 1;"><i class="bi bi-gem"></i> PREMIUM</div>' : '';
            
            container.innerHTML = `
                <div class="d-flex gap-2 me-3 align-items-center border-end pe-3 border-secondary">
                    <button class="btn btn-sm btn-dark rounded-circle position-relative shadow-sm" style="width: 32px; height: 32px; padding: 0;" onclick="loadNotificationHistory()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                        <i class="bi bi-bell-fill"></i>
                        <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle" style="display: none;"></span>
                    </button>
                    <button class="btn btn-sm btn-dark rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 0;" onclick="loadHistory()" title="–ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–π"><i class="bi bi-folder2-open"></i></button>
                    <button class="btn btn-sm btn-danger rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 0;" onclick="logout()" title="–í—ã—Ö–æ–¥"><i class="bi bi-box-arrow-right"></i></button>
                </div>
                <div class="d-flex flex-column align-items-center justify-content-center me-3" style="line-height: 1.1; height: 40px;">
                    <a href="/profile" class="fw-bold text-decoration-none text-white small" style="text-shadow: 0 0 5px rgba(0,0,0,0.5);">${username}</a>
                    ${adminBadge || premiumBadge}
                </div>
                ${avatarHtml}
            `;
        } else {
            container.innerHTML = `
                <a href="/login_page" class="btn btn-sm btn-outline-primary">${t.authLogin}</a>
                <a href="/register_page" class="btn btn-sm btn-primary">${t.authRegister}</a>
            `;
        }
    }

    window.logout = async function() {
        await fetch('/logout');
        lastAuthData = { isAuth: false, username: '', avatarUrl: '', isPremium: false };
        updateAuthUI(false);
        location.reload();
    }

    // --- –ò–°–¢–û–†–ò–Ø –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
    window.loadHistory = async function() {
        const el = document.getElementById('historyModal');
        if(!el) return;
        const modal = bootstrap.Modal.getOrCreateInstance(el);
        modal.show();
        
        const t = window.translations[window.appSettings.lang] || window.translations['ru'];
        const list = document.getElementById('historyList');
        if(list) list.innerHTML = `<div class="text-center p-3">${t.loading}</div>`;
        
        try {
            const res = await fetch('/my_history');
            if (res.status === 401) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', true);
            const data = await res.json();
            if(list) {
                if (data.length === 0) {
                    list.innerHTML = `<div class="text-center p-3 text-muted">${t.historyEmpty}</div>`;
                    return;
                }
                list.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('a');
                    div.className = 'list-group-item list-group-item-action';
                    div.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 text-truncate" style="max-width: 70%;">${item.title}</h6>
                            <small class="text-muted">${new Date(item.date).toLocaleDateString()}</small>
                        </div>
                        <small class="text-muted text-truncate d-block">${item.url}</small>
                    `;
                    div.onclick = () => {
                        const urlInput = document.getElementById('urlInput');
                        if (urlInput && typeof getInfo === 'function') {
                            urlInput.value = item.url;
                            modal.hide();
                            getInfo();
                        }
                    };
                    list.appendChild(div);
                });
            }
        } catch (e) {
            if(list) list.innerHTML = `<div class="text-danger p-3">${t.errorLoad}</div>`;
        }
    }

    window.clearHistory = async function() {
        const t = window.translations[window.appSettings.lang] || window.translations['ru'];
        
        Swal.fire({
            title: t.historyModalTitle,
            text: t.clearHistoryConfirm,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '–î–∞',
            cancelButtonText: '–ù–µ—Ç'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch('/clear_history', { method: 'POST' });
                    const data = await res.json();
                    if (data.success) loadHistory();
                    else Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', 'error');
                } catch (e) { Swal.fire('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error'); }
            }
        });
    }

    window.loadNotificationHistory = async function() {
        const el = document.getElementById('notificationHistoryModal');
        if(!el) return;
        const modal = bootstrap.Modal.getOrCreateInstance(el);
        modal.show();
        
        const t = window.translations[window.appSettings.lang] || window.translations['ru'];
        const list = document.getElementById('notificationList');
        if(list) list.innerHTML = `<div class="text-center p-3">${t.loading}</div>`;
        
        fetch('/mark_notifications_read', { method: 'POST' });
        const badge = document.getElementById('notifBadge');
        if (badge) badge.style.display = 'none';
        
        try {
            const res = await fetch('/notification_history');
            const data = await res.json();
            if(list) {
                if (data.length === 0) {
                    list.innerHTML = `<div class="text-center p-3 text-muted">${t.noNotifications}</div>`;
                    return;
                }
                list.innerHTML = '';
                data.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-group-item';

                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'd-flex w-100 justify-content-between align-items-center';

                    const dateSmall = document.createElement('small');
                    dateSmall.className = 'text-muted';
                    const date = new Date(item.date + 'Z').toLocaleString();
                    dateSmall.textContent = date;

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'btn btn-sm btn-link text-danger p-0';
                    deleteButton.innerHTML = '<i class="bi bi-x-lg"></i>';
                    deleteButton.onclick = () => deleteNotification(item.id, deleteButton);

                    const messageP = document.createElement('p');
                    messageP.className = 'mb-1 pe-3';
                    messageP.textContent = item.message;

                    headerDiv.appendChild(dateSmall);
                    headerDiv.appendChild(deleteButton);
                    itemDiv.appendChild(headerDiv);
                    itemDiv.appendChild(messageP);
                    list.appendChild(itemDiv);
                });
            }
        } catch (e) {
            if(list) list.innerHTML = `<div class="text-danger p-3">${t.errorLoad}</div>`;
        }
    }

    window.deleteNotification = async function(id, btn) {
        const t = window.translations[window.appSettings.lang] || window.translations['ru'];
        
        Swal.fire({
            title: t.notifModalTitle,
            text: t.deleteNotifConfirm,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '–î–∞',
            cancelButtonText: '–ù–µ—Ç'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await fetch('/hide_notification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    const item = btn.closest('.list-group-item');
                    item.remove();
                    const list = document.getElementById('notificationList');
                    if (list && list.children.length === 0) {
                        list.innerHTML = `<div class="text-center p-3 text-muted">${t.noNotifications}</div>`;
                    }
                } catch (e) { Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error'); }
            }
        });
    }

    // --- TOASTS & COOKIES ---
    window.showToast = function(message, isError = false) {
        if (!window.appSettings.toasts && !isError) return;
        const toastEl = document.getElementById('liveToast');
        const toastBody = document.getElementById('toastBody');
        if(toastEl && toastBody) {
            toastEl.className = isError ? 'toast align-items-center text-bg-danger border-0' : 'toast align-items-center text-bg-primary border-0';
            toastBody.innerText = message;
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
            toast.show();
        }
    }

    window.acceptCookies = function() {
        localStorage.setItem('cookieConsent', 'accepted');
        const banner = document.getElementById('cookie-banner');
        if(banner) banner.style.display = 'none';
    }
    window.rejectCookies = function() {
        localStorage.setItem('cookieConsent', 'rejected');
        const banner = document.getElementById('cookie-banner');
        if(banner) banner.style.display = 'none';
    }

    // --- SNOW ---
    const snowContainer = document.getElementById('snow-container');
    function createSnowflake(isInit = false) {
        if (!window.appSettings.snow || !snowContainer) return;
        const snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.opacity = Math.random() * 0.6 + 0.4;
        const size = Math.random() * 6 + 3 + 'px';
        snowflake.style.width = size;
        snowflake.style.height = size;
        const duration = Math.random() * 5 + 5 + 's';
        snowflake.style.animationDuration = duration;
        if (isInit) snowflake.style.top = Math.random() * 100 + 'vh';
        snowContainer.appendChild(snowflake);
        setTimeout(() => snowflake.remove(), parseFloat(duration) * 1000);
    }

    // --- WEBSOCKETS ---
    try {
        const socket = io();
        socket.on('connect', () => {
            checkUnreadStatus();
        });
        socket.on('new_notification', (data) => {
            showToast('üì¢ ' + data.message);
            const badge = document.getElementById('notifBadge');
            if (badge) badge.style.display = 'block';
        });
    } catch(e) { console.log('Socket.io not available'); }

    async function checkUnreadStatus() {
        try {
            const res = await fetch('/check_notifications?last_id=0');
            const data = await res.json();
            const badge = document.getElementById('notifBadge');
            if (badge) {
                if (data.unread_count > 0) badge.style.display = 'block';
                else badge.style.display = 'none';
            }
        } catch (e) {}
    }

    // --- –§–£–ù–ö–¶–ò–ò –ì–õ–ê–í–ù–û–ô –°–¢–†–ê–ù–ò–¶–´ ---
    window.validateUrl = function() {
        const url = document.getElementById('urlInput').value.trim();
        const btn = document.getElementById('searchBtn');
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https:// –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ—á–∫—É
        const isValid = /^https?:\/\/.+\..+/.test(url);
        btn.disabled = !isValid;
        return isValid;
    }

    // --- –ú–ï–ù–ï–î–ñ–ï–† –ó–ê–ì–†–£–ó–û–ö (Refactored) ---
    const VideoDownloader = {
        currentTaskId: null,
        progressInterval: null,

        async getInfo() {
            const url = document.getElementById('urlInput').value;
            if (!url) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É!', true);

            this.resetUI(true); // –°–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

            const btn = document.getElementById('searchBtn');
            const t = window.translations[window.appSettings.lang] || window.translations['ru'];
            const originalText = t.searchBtn;
            
            btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${lastAuthData.isPremium ? t.searchingPremium : t.searchingFree}`;
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('url', url);

                const response = await fetch('/get_info', { 
                    method: 'POST', 
                    body: formData,
                    headers: { 'X-CSRFToken': Utils.getCsrfToken() }
                });
                const data = await response.json();

                if (response.ok) {
                    this.renderInfo(data, url, t);
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.error, true);
                }
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e, true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        },

        renderInfo(data, url, t) {
            document.getElementById('thumb').src = data.thumbnail;
            document.getElementById('videoTitle').innerText = data.title;
            document.getElementById('duration').innerText = data.duration;
            
            const container = document.getElementById('buttonsContainer');
            container.innerHTML = '';
            
            const labels = { 'best': t.qualityBest, '1080': t.quality1080, '720': t.quality720, 'audio': t.qualityAudio };
            ['best', '1080', '720', 'audio'].forEach(key => {
                if (data.sizes[key]) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-outline-primary quality-btn';
                    button.innerHTML = `${labels[key] || key}<br><small style="opacity:0.7">${data.sizes[key]}</small>`;
                    button.onclick = () => this.startDownload(url, key);
                    container.appendChild(button);
                }
            });

            if (data.is_playlist && data.entries) {
                this.renderPlaylist(data.entries);
            }

            document.getElementById('videoInfo').style.display = 'block';
        },

        renderPlaylist(entries) {
            const plContainer = document.getElementById('playlistContainer');
            plContainer.innerHTML = '';
            
            const card = Utils.createElement('div', 'card bg-dark border-secondary shadow-sm');
            const header = Utils.createElement('div', 'card-header border-secondary text-center text-white-50 small fw-bold text-uppercase py-2', '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞');
            header.style.background = 'rgba(255,255,255,0.05)';
            
            const list = Utils.createElement('div', 'list-group list-group-flush');
            list.style.maxHeight = '400px';
            list.style.overflowY = 'auto';

            entries.forEach((entry, index) => {
                const item = Utils.createElement('div', 'list-group-item bg-transparent text-light border-secondary d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-2 py-3');
                
                const infoDiv = Utils.createElement('div', 'd-flex align-items-center text-truncate me-2');
                infoDiv.style.flex = '1';
                
                const badge = Utils.createElement('span', 'badge bg-secondary bg-opacity-25 text-secondary me-3 rounded-pill', index + 1);
                badge.style.minWidth = '25px';
                
                const title = Utils.createElement('span', 'text-truncate small fw-medium', entry.title);
                title.title = entry.title; // Tooltip

                infoDiv.append(badge, title);

                const btnGroup = Utils.createElement('div', 'd-flex gap-2 shrink-0 justify-content-end');
                const singleUrl = `https://www.youtube.com/watch?v=${entry.id}`;
                
                const btnMp4 = Utils.createElement('button', 'btn btn-sm btn-outline-info');
                btnMp4.innerHTML = '<i class="bi bi-camera-video"></i> MP4';
                btnMp4.onclick = () => this.startDownload(singleUrl, 'best');

                const btnMp3 = Utils.createElement('button', 'btn btn-sm btn-outline-success');
                btnMp3.innerHTML = '<i class="bi bi-music-note-beamed"></i> MP3';
                btnMp3.onclick = () => this.startDownload(singleUrl, 'audio');

                btnGroup.append(btnMp4, btnMp3);
                item.append(infoDiv, btnGroup);
                list.appendChild(item);
            });

            card.append(header, list);
            plContainer.appendChild(card);
            plContainer.style.display = 'block';
        },

        async startDownload(url, quality) {
            document.getElementById('buttonsContainer').style.pointerEvents = 'none';
            document.getElementById('buttonsContainer').style.opacity = '0.5';
            document.getElementById('progress-section').style.display = 'block';
            
            const formData = new FormData();
            formData.append('url', url);
            formData.append('quality', quality);

            try {
                const response = await fetch('/start_download', { 
                    method: 'POST', 
                    body: formData,
                    headers: { 'X-CSRFToken': Utils.getCsrfToken() }
                });
                const data = await response.json();

                if (response.ok) {
                    this.currentTaskId = data.task_id;
                    this.trackProgress();
                } else {
                    showToast('–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: ' + data.error, true);
                    this.resetUI();
                }
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞: ' + e, true);
                this.resetUI();
            }
        },

        trackProgress() {
            const t = window.translations[window.appSettings.lang] || window.translations['ru'];
            if (this.progressInterval) clearInterval(this.progressInterval);
            
            this.progressInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/progress/${this.currentTaskId}`);
                    const data = await res.json();
                    const bar = document.getElementById('progressBar');
                    const statusText = document.getElementById('statusText');
                    const percentText = document.getElementById('percentText');

                    if (data.status === 'downloading') {
                        bar.style.width = data.progress + '%';
                        bar.className = 'progress-bar progress-bar-striped progress-bar-animated';
                        statusText.innerText = (data.message && /\d/.test(data.message)) ? `${t.statusDownloading} (${data.message})` : t.statusDownloading;
                        percentText.innerText = Math.round(parseFloat(data.progress)) + '%';
                    } else if (data.status === 'processing') {
                        bar.style.width = '100%';
                        bar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-warning';
                        statusText.innerText = t.statusProcessing;
                        percentText.innerText = '100%';
                    } else if (data.status === 'finished') {
                        clearInterval(this.progressInterval);
                        bar.className = 'progress-bar bg-success';
                        statusText.innerText = t.statusFinished;
                        document.getElementById('downloadBtn').href = `/get_file/${this.currentTaskId}`;
                        if (navigator.share) document.getElementById('shareBtn').style.display = 'block';
                        document.getElementById('progress-section').style.display = 'none';
                        document.getElementById('download-section').style.display = 'block';
                    } else if (data.status === 'error') {
                        clearInterval(this.progressInterval);
                        showToast(t.statusError + data.error, true);
                        this.resetUI();
                    }
                } catch (e) { console.error(e); }
            }, 1000);
        },

        resetUI(full = false) {
            document.getElementById('buttonsContainer').style.pointerEvents = 'auto';
            document.getElementById('buttonsContainer').style.opacity = '1';
            document.getElementById('progress-section').style.display = 'none';
            if (full) {
                document.getElementById('videoInfo').style.display = 'none';
                document.getElementById('download-section').style.display = 'none';
                document.getElementById('playlistContainer').style.display = 'none';
            }
        }
    };

    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è HTML –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    window.getInfo = () => VideoDownloader.getInfo();
    window.startDownload = (u, q) => VideoDownloader.startDownload(u, q);

    // --- –§—É–Ω–∫—Ü–∏—è "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ---
    window.shareFile = async function() {
        const downloadBtn = document.getElementById('downloadBtn');
        const shareBtn = document.getElementById('shareBtn');
        const originalText = shareBtn.innerText;
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É (–∏–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, –∏–ª–∏ —É–∂–µ –ª–æ–∫–∞–ª—å–Ω—ã–π blob)
        let url = downloadBtn.href;
        
        try {
            shareBtn.disabled = true;
            shareBtn.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            let blob;
            let filename = 'video_download';

            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤–µ–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å
            if (url.includes('/get_file/')) {
                const res = await fetch(url);
                if (!res.ok) throw new Error('–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ —Å–∫–∞—á–∞–Ω)');
                blob = await res.blob();
                
                // –ü—ã—Ç–∞–µ–º—Å—è —É–∑–Ω–∞—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                const disposition = res.headers.get('Content-Disposition');
                if (disposition && disposition.match(/filename="?([^"]+)"?/)) {
                    filename = disposition.match(/filename="?([^"]+)"?/)[1];
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", —á—Ç–æ–±—ã –æ–Ω–∞ –±—Ä–∞–ª–∞ —Ñ–∞–π–ª –∏–∑ –ø–∞–º—è—Ç–∏ (—Ç–∞–∫ –∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–Ω —É–¥–∞–ª–∏—Ç—Å—è)
                const blobUrl = URL.createObjectURL(blob);
                downloadBtn.href = blobUrl;
                downloadBtn.download = filename; 
            } else {
                // –ï—Å–ª–∏ —É–∂–µ blob, –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º –µ–≥–æ
                blob = await fetch(url).then(r => r.blob());
                filename = downloadBtn.download || 'video_download.mp4';
            }

            const file = new File([blob], filename, { type: blob.type });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: '–í–∏–¥–µ–æ', text: '–°–∫–∞—á–∞–Ω–æ —Å Video Downloader' });
            } else {
                throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.');
            }
        } catch (e) {
            showToast('–û—à–∏–±–∫–∞: ' + e.message, true);
        } finally {
            shareBtn.disabled = false;
            shareBtn.innerText = originalText;
        }
    }

document.addEventListener('DOMContentLoaded', () => {
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    loadSettings();
    checkAuth();
    if (!localStorage.getItem('cookieConsent') && window.location.pathname === '/') { // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä –∫—É–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const banner = document.getElementById('cookie-banner');
        if(banner) banner.style.display = 'block';
    }
    for (let i = 0; i < 50; i++) createSnowflake(true);
    setInterval(() => createSnowflake(false), 50);
    document.addEventListener('mousemove', (e) => {
        if(snowContainer) {
            const x = (e.clientX / window.innerWidth - 0.5) * 20;
            const y = (e.clientY / window.innerHeight - 0.5) * 20;
            snowContainer.style.transform = `translate(${x}px, ${y}px)`;
        }
    });
});

// –õ–æ–≥–∏–∫–∞ –∑–∞—Å—Ç–∞–≤–∫–∏ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
async function initApp() {
    const splash = document.getElementById('splash-screen');
    if(!splash) return;

    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const authData = await checkAuth(); 
    if (!authData.authenticated) {
        window.location.href = '/register_page';
        return;
    }

    // 2. –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —É–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—Å—Ç–∞–≤–∫–æ–π
    let isReload = false;
    try {
        const navEntry = performance.getEntriesByType("navigation")[0];
        isReload = navEntry && navEntry.type === 'reload';
    } catch(e) {}

    if (!isReload && document.referrer && document.referrer.startsWith(window.location.origin)) {
        splash.style.display = 'none';
    } else {
        setTimeout(() => {
            splash.classList.add('hidden');
            setTimeout(() => { splash.style.display = 'none'; }, 500);
        }, 1500);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º initApp –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (–∏–ª–∏ —Å—Ä–∞–∑—É, –µ—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞)
if (document.readyState === 'complete') {
    initApp();
} else {
    window.addEventListener('load', initApp);
}
</script>
</body>
</html>
